(defn relay [x i]
    (when (:next x)
        (send (:next x) relay i))
    (when (and (zero? i) (:report-queue x))
        (:put (:report-queue x) i))
    x)

(defn run [m n]
    (let [q (new java.util.concurrent.SynchronousQueue)
          hd (reduce (fn [next _] (agent {:next next}))
                     (agent {:report-queue q}) (range (dec m)))]
        (doseq [i (reverse (range n))]
            (send hd relay i))
        (.take q)))

(time (run 1000 1000))